<!DOCTYPE html>
<html>
  <head>
    <title>Insteadman</title>
      <script src="./vendor/jquery/jquery-2.1.4.min.js"></script>
  </head>
  <body>
    <div id="game_block" data-game_id="">
        <h2 id="game_title">Insteadman</h2>
        <img id="game_logo" src="./resources/images/logo.png" alt="Insteadman">
        <button id="game_run" style="display: none;">Run</button>
        <button id="game_install" style="display: none;">Install</button>
        <button id="game_delete" style="display: none;">Delete</button>
    </div>

    <table id="games_list">
        <tr>
            <th>Title</th>
            <th>Version</th>
            <th>Size</th>
        </tr>
    </table>

    <script>
        var gui = require('nw.gui');
        var mb = new gui.Menu({type:"menubar"});
        mb.createMacBuiltin("Insteadman");
        gui.Window.get().menu = mb;

        var interpreterFinder = require('./lib/interpreter_finder');
        var insteadInterpreterFinder = new interpreterFinder.InsteadInterpreterFinderMac;
//        insteadInterpreterFinder.findInterpreter(function(interpreterPath) {
//            insteadInterpreterFinder.checkInterpreter(interpreterPath, function(version) {
//                version = version || "not found";
//                document.getElementById('interpreter_version').innerText = version;
//            });
//        });

        var configurator = new (require('./lib/configurator').ConfiguratorMac);
//        console.log(configurator.getValue("lang"));
//        console.log(configurator.getValue("lang1"));
//        configurator.setValue("lang1", "dd");
//        console.log(configurator.getAll());
//        if (configurator.save()) {
//            console.log("ok");
//        }

        var statusBar = require('status-bar');
        var bar = statusBar.create({ total: 0 })
        //barformatter = new statusBar.Formatter(statusBar);

        var manager = new (require('./lib/manager').ManagerMac)(configurator);

//        manager.updateRepositories();
        var globalGamesList = [];

        function render() {
            globalGamesList = manager.getSortedCombinedGameList();

            $('#games_list .games_list_item').remove();

            var gamesHtml = '';

            globalGamesList.forEach(function (game, id) {
                var gameTitle = game.title;
                if (game.installed) {
                    gameTitle = '<strong>' + gameTitle + '</strong>';
                }
                gamesHtml += '<tr class="games_list_item" data-id="' + id + '"><td>' + gameTitle + '</td><td>' + game.version + '</td><td>' + bar.format.storage(game.size) + '</td></tr>';
            });
            $('#games_list').append(gamesHtml);
        }

        render();

        $('.games_list_item').click(function () {
            var gameId = $(this).data('id');
            var game = globalGamesList[gameId];
            $('#game_block').data('game_id', gameId);
            $('#game_title').text(game.title);

            if (game.installed) {
                $('#game_install').hide();
                $('#game_run').show();
                $('#game_delete').show();
            } else {
                $('#game_install').show();
                $('#game_run').hide();
                $('#game_delete').hide();
            }
        });

        $('#game_run').click(function () {
            var gameId = $(this).parent('#game_block').data('game_id');
            var game = globalGamesList[gameId];
            manager.runGame(game);
        });

        $('#game_delete').click(function () {
            var gameId = $(this).parent('#game_block').data('game_id');
            var game = globalGamesList[gameId];
            manager.deleteGame(game, function() {
                render();
            });
        });

//        $('#game_logo').click(function () {
//            $('#games_list .games_list_item').remove();
//        });
    </script>
  </body>
</html>
